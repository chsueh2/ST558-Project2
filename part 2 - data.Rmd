---
title: "ST558 Porject 1: Part 2"
author: "Bridget Knapp and Chien-Lan Hsueh"
institute: Online Statistics Master Program, NCSU
date: "`r Sys.Date()`"
output:
  html_notebook:
    theme: cerulean
    highlight: haddock
    code_folding: none
  html_document:
    df_print: paged
---

```{r include=FALSE}
knitr::opts_chunk$set(fig.path = "./images/")
```


```{r, include=FALSE}
if (!require("pacman")) utils::install.packages("pacman", dependencies = TRUE)

pacman::p_load(
  here,
  stats,
  tidyverse,
  lubridate,
  glue,
  skimr,
  caret,
  rpart, randomForest, gbm
)
```

## Data


The data file is saved in the `data` folder. After reading the raw data, we first check what variables it contains and if there is any missing or NA data.

```{r}
df_raw <- read_csv(here("data", "OnlineNewsPopularity.csv"))
 
# show the raw data
head(df_raw)

# check structure
str(df_raw)

# check if any missing values
anyNA(df_raw)
```


First we check on the six `data_channel_is_*` columns with an one-way table on the sum of their values for each row (record):

```{r}
# create a count table on the sum of the six `data_channel_is_*` columns
tbl_channel_raw <- df_raw %>% 
  # deal with columns of interest only for computing efficiency
  select(starts_with("data_channel_is_")) %>% 
  mutate(sum_of_channels = rowSums(across(everything()))) %>% 
  select(sum_of_channels) %>% 
  # create an one-way table for counts
  table()

tbl_channel_raw

```


Among the `r sum(tbl_channel_raw)` record, `r tbl_channel_raw["1"]` records are from one of the 6 channels (`lifestyle`, `entertainment`, `bus` for business, `socmed` for social media, `tech` and `world`) and the other `r tbl_channel_raw["0"]` are from the other channel (not included in these 6 channels). Therefore, we can create a new data channel `misc` to label the. 


Next, we will prepare the data with the following steps:

- remove `url` and `timedelta` since we are not using them as predictors (non-predictive)
- create a new column `data_channel_is_misc` for those records not from the 6 channels
- convert the 7 `data_channel_is_*` columns (original 6 + newly created 1 in the last step) into a long-form column `channel`
- convert the 7 `weekday_is_*` columns into a long-column `weekday`
- remove the columns created in the intermediate steps
- convert categorical variables `channel`, `weekday` and `is_weekend` to factors
- move the response variable `shares` and the categorical predictors `channel`, `weekday` and `is_weekend` to the first columns for easy handling when analyzing models


```{r}
df <- df_raw %>% 
  select(-url, -timedelta) %>% 
  mutate(
    sum_of_channels = rowSums(across(starts_with("data_channel_is_"))),
    # label records not from the 6 channels
    data_channel_is_misc = as.integer(sum_of_channels == 0)
  ) %>% 
  # pivot the channel columns (to a long form)
  pivot_longer(
    cols = starts_with("data_channel_is_"),
    names_to = "channel",
    names_prefix = "data_channel_is_",
    values_to = "channel_indicator"
  ) %>% 
  # pivot the channel columns (to a long form)
  pivot_longer(
    cols = starts_with("weekday_is_"),
    names_to = "weekday",
    names_prefix = "weekday_is_",
    values_to = "weekday_indicator"
  ) %>% 
  # remove redundant records
  filter(
    channel_indicator == 1,
    weekday_indicator == 1
  ) %>% 
  # remove redundant columns
  select(-sum_of_channels, -channel_indicator, -weekday_indicator) %>% 
  # convert categorical variables to factors
  mutate(
    channel = factor(channel),
    weekday = factor(weekday, levels = levels(wday(Sys.Date(), label = T, abbr = F)) %>% str_to_lower()),
    is_weekend = if_else(is_weekend == 1, "Y", "N") %>% factor()
  ) %>% 
  relocate(shares, channel, weekday, is_weekend)


# show the data frame
df
```
Note that the data frame has the same number of rows with the raw data.


## Split the Data

We use `caret::createDataPartition()` to create a 70/30 split of training and test sets. This is done with `set.seed()`
to make this analysis reproducible.
```{r}
set.seed(2022)

# split data
trainIndex <- createDataPartition(df$shares, p = 0.7, list = F)
df_train <- df[trainIndex, ]
df_test <- df[-trainIndex, ]
```


